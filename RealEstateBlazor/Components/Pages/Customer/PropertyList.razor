@page "/properties"
@page "/properties/{page:int}"   
@using Application.DTOs
@inject NavigationManager Navigation
@inject IPropertyService _propertyService

<div class="property-list">
    @if (PagedProperties is null || !PagedProperties.Any())
    {
        <p>No properties found.</p>
    }
    else
    {
        if (page==1)
        {
            <h2>Properties</h2>
        }
        else
        {
            <h2>(Showing @((_currentPage - 1) * _pageSize + 1)-@(Math.Min(_currentPage * _pageSize, properties?.Count ?? 0)) of @(properties?.Count ?? 0))</h2>
        }
        <div class="cards">
            @foreach (var property in PagedProperties)
            {
                <PropertyCard Property="property" />
            }
        </div>
    }
</div>
<div class="pagination">
    <button @onclick="PreviousPage" disabled="@(_currentPage <= 1)">Previous</button> <!--Previous page button is disabled if I'm on page 1-->
    <span>@_currentPage of @_totalPages</span>
    <button @onclick="NextPage" disabled="@(_currentPage >= _totalPages)">Next</button> <!--Next page button is disabled if I'm on last page-->
</div>

@code {
    [Parameter]
    public int page { get; set; } = 1; // from URL
    private List<PropertyListDTO>? properties;
    private IEnumerable<PropertyListDTO> PagedProperties = Enumerable.Empty<PropertyListDTO>();
    private int _currentPage = 1;
    private int _pageSize = 9;  
    private int _totalPages = 1;
    protected override async Task OnInitializedAsync() //blazor lifecycle type: runs once when component is created
    {
        if (page >= 1 && page <= _totalPages)
        {
            _currentPage = page;
        }
        else if (page < 1)
        {
            _currentPage = 1;
            Navigation.NavigateTo("/properties/1", replace: true);
            return;
        }
        else
        {
            _currentPage = _totalPages;
            Navigation.NavigateTo($"/properties/{_totalPages}", replace: true);
            return;
        }
        properties = await _propertyService.GetCustomerPropertyList();
        _totalPages = (int)Math.Ceiling((double)properties.Count / _pageSize); //divides property cards on each page
        UpdatePagedProperties();
    }
    private void UpdatePagedProperties()
    {
        PagedProperties = properties
            .Skip((_currentPage - 1) * _pageSize) 
            .Take(_pageSize); //to skip 6 (or multiple of 6) before current page and show the next 6
    }
    private void PreviousPage()
    {
        if (_currentPage > 1)
        {
            _currentPage--;
            NavigateToPage(_currentPage);
        }
    }
    private void NextPage()
    {
        if (_currentPage < _totalPages)
        {
            _currentPage++;
            NavigateToPage(_currentPage);
        }
    }
    private void NavigateToPage(int page)
    {
        Navigation.NavigateTo($"/properties/{page}");
    }

} 










@* @page "/properties"
@page "/properties/{Page:int}"
@using Application.DTOs
@inject NavigationManager Navigation
@inject IPropertyService _propertyService

<h1>Pagination Test with OnParametersSetAsync</h1>
<p>Page parameter: @Page</p>
<p>Properties loaded: @(properties?.Count ?? 0)</p>
<p>Current page: @_currentPage</p>
<p>Total pages: @_totalPages</p>

@code {
    [Parameter]
    public int Page { get; set; } = 1;
    
    private List<PropertyListDTO>? properties;
    private int _currentPage = 1;
    private int _pageSize = 9;  
    private int _totalPages = 1;
    
    protected override async Task OnInitializedAsync()
    {
        // Handle redirects FIRST, before loading data
        if (Page < 1)
        {
            Navigation.NavigateTo("/properties/1", replace: true);
            return; // Don't load data, just redirect
        }

        // Now load data
        properties = await _propertyService.GetCustomerPropertyList();

        if (properties != null)
        {
            _totalPages = (int)Math.Ceiling((double)properties.Count / _pageSize);

            // Check if page is too high AFTER we know total pages
            if (Page > _totalPages)
            {
                Navigation.NavigateTo($"/properties/{_totalPages}", replace: true);
                return;
            }
        }

        _currentPage = Page;
        UpdatePagedProperties();
    }
    
    protected override async Task OnParametersSetAsync()
    {
        Console.WriteLine($"=== OnParametersSetAsync START ===");
        Console.WriteLine($"page parameter: {Page}");
        Console.WriteLine($"_totalPages: {_totalPages}");
        Console.WriteLine($"properties?.Count: {properties?.Count}");
        Console.WriteLine($"_currentPage: {_currentPage}");

        if (properties != null)
        {
            if (Page >= 1 && Page <= _totalPages)
            {
                Console.WriteLine($"✓ Valid page range - no redirect");
                _currentPage = Page;
            }
            else if (Page < 1)
            {
                Console.WriteLine($"❌ Page < 1 - redirecting to page 1");
                Navigation.NavigateTo("/properties/1", replace: true);
                return;
            }
            else
            {
                Console.WriteLine($"❌ Page > totalPages ({Page} > {_totalPages}) - redirecting to last page");
                Navigation.NavigateTo($"/properties/{_totalPages}", replace: true);
                return;
            }
        }

        Console.WriteLine($"=== OnParametersSetAsync END ===");
    }
    private void UpdatePagedProperties()
    {
        PagedProperties = properties
            .Skip((_currentPage - 1) * _pageSize) //to skip 6 (or multiple of 6) before current page and show the next 6
            .Take(_pageSize);
    }
} *@